---
layout: post
title:  "Lomax to the Max :: Nokogiri"
date:   2016-08-08 22:19:05 +0000
---

![Alan Lomax, Bahamas, 1935](http://cdn.loc.gov/service/pnp/ppmsc/00500/00552v.jpg)
<blockquote>
<p style="text-align: justify;"><em><a href="http://www.loc.gov/folklife/lomax/michiganproject.html" target="_blank">In 1938 the Library of Congress dispatched Alan Lomax</a>—already a seasoned field worker at age 23—to complete a folklife survey of the Great Lakes region. He set off in a 1935 Plymouth Deluxe 4-door sedan, toting a Presto instantaneous disc recorder, a still camera, and a moving image camera. He returned almost three months later, having driven thousands of miles on barely paved roads, with a cache of 250 discs and 8 reels of film. These materials documented the diversity of ethnicity—Irish, Finnish, Serbian, Polish, German, Croatian, Canadian French, Hungarian, and more—in Michigan, as well as cultural expression among loggers and lake sailors.</em></p>
</blockquote>
<h2 class="p1"><strong>Goodnight Irene</strong></h2>
<p class="p1">That a <a href="http://the78project.com/getting-to-know-the-presto-1-nightmares-in-recording-and-in-history/">high-tech scraper</a> shaped my identity just bobbed to the surface for me. I’m a musician, and <a href="https://en.wikipedia.org/wiki/Goodnight,_Irene">“Goodnight Irene”</a> is maybe the first song I remember learning. I’d always figured my aunt Doris got it from my grandpa, a Missouri-born, geetar-pickin’ farm boy who cleaned Flint’s water back when we thought we could drink it. He’d sing everything like he wrote it himself. And if you ever expected to get up from the kitchen table, or arrive at an actual destination on a car trip, you’d sing right along with him. For sides, he’d do intricate demos of various bare-handed whistles and poisonous mushroom lessons. Most of “his” songs were cowboy ballads with at least 78 verses. It sounds culture-rich to write it out, but the whole thing was aggressively call and response, sometimes Pentecostally so. In this bountiful valley, my aunt’s Pac-Man title at the doughnut shop stood out as peak-tech. But my grandpa didn’t write “Goodnight Irene”, and I doubt he learned it at a kitchen table. It was likely brought to him over the radio waves, by way of the Louisiana State Penitentiary, from John and <a href="https://en.wikipedia.org/wiki/Alan_Lomax">Alan Lomax's</a> "Presto"-junction with Lead Belly’s vocal chords. I mean: my grandpa and aunt's phrasing sounded suspiciously like Lead Belly's.</p>
<iframe width="420" height="315" src="https://www.youtube.com/embed/xn50JSI0W-E" frameborder="0" allowfullscreen></iframe>

&nbsp;
<p class="p1"><span class="s1"><i>Human beings are about 98 percent culture and about 2 percent individuals.</i></span></p>
<p class="p1"><span style="line-height: 1.7;">—Alan Lomax, interviewed by Charles Kuralt at Lomax's Hunter College office, New York City, 1991</span></p>

<h2 class="p1"><strong>The Philosophy of Scrapers</strong></h2>
<p class="p1"><span class="s1">Scrapers positively need an innovative purpose. They need to seek information previously thought to be functionally inaccessible. When Alan and John decided to make that journey to collect the undiscovered folk songs of the United States, they weren’t just staring at a recorder wondering what to do with it. I can’t imagine their learning how to use it without a purpose driving them. The thing weighed 650 lbs, and that was considered portable in those days, if broken into 100lb parts. Thankfully, my scraper is a bit lighter, I don’t have to leave home to use it, and neither do you!</span></p>
<p class="p1"><span class="s1">Here’s a bit about the Lomax“scraper”</span></p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/ACa7NzesY4w" frameborder="0" allowfullscreen></iframe><span class="s2">
</span>
<p class="p1"><span class="s1">Just the idea of “scraper” feels unpleasant, probably painfully invasive. But a web scraper should be a surgical tool that reveals novel data; it should amplify collection efforts, and provide new possibilities in multi-dimensional data presentation. That said, scraped data is only as interesting as the data it scrapes. One way of curating interesting stuff is to get multiple web sources sharing specific pieces of information at a gem party you create for them. Once shared, your gem can whip these into a meringue of interesting conclusions.</span></p>
<p class="p1"><span class="s1">The <a href="https://www.loc.gov/audio/?fa=location%3Amichigan">Lomax Archive of Michigan Recordings</a> has only recently become available online. I’ve explored the archive myself, as a curious former Michigander. As a musician, I was dying to know if some of these were the only known recordings of these songs. There was no way to tell from this archive, unless you wanted to look up each song individually. Musicians love discovering forgotten music; it can tell a story of a place and a people like few other records.</span></p>
<p class="p1"><span class="s1">(For a really cool example of this, check out my pianist friend <a href="http://johndavispianist.com/">John Davis’</a> excellent recordings of the compositions of Blind Tom and Blind Boone. He discovered many of these pieces himself, by digging into local libraries and rummaging through rare book sales. This practice led him on a lifelong journey into the origins of ragtime, the blues, and (Black-)American History through music. I can’t wait to tell him about scrapers!)</span></p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/MbOnsIptqDc" frameborder="0" allowfullscreen></iframe><span class="s2">
</span>
<h2 class="p1"></h2>
<h2 class="p1"><strong>Musical Heritage Is Important Stuff</strong></h2>
<p class="p1"><span class="s1">I’d love to put together a band that delves into some of these lost songs in new ways, and perform them throughout Michigan. It would be wonderful to encourage other musicians and teachers of music there to do the same. When I was coming up, I was never taught anything about my musical heritage by those officially entrusted with my artistic education, unless you count my fifth grade chorus’ hostilely micro-tonal rendition of “Erie Canal”, but that’s not Michigan. </span></p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/7wrY-XPVHCg" frameborder="0" allowfullscreen></iframe>
<p class="p1"><span class="s1">(note: “grade school micro-tonal” is one of the best genres)<span class="Apple-converted-space">  </span>This sort of philosophy would be considered a crime of omission, probably capital suppression in a place like New Orleans or St. Louis or Puerto Rico. One would think we might have learned about Motown or about Betty Carter, at least, (since she lived down the street) in school. We were kept to the Mozart, I’m afraid, and what a shame. Imagine the blowback if Austrian kids were only taught the blues. </span></p>

<h2 class="p1"><strong>Enter the Web Scraper/CLI Gem</strong></h2>
<iframe width="420" height="315" src="https://www.youtube.com/embed/IwYztkl1BhY" frameborder="0" allowfullscreen></iframe>
<p class="p1"><a href="https://github.com/nicolefederici/lomax">https://github.com/nicolefederici/lomax</a></p>
<p class="p1"><span class="s1">So, I’m happy to be able to take the Lomax research a serious step further with a simple Nokogiri scraper, some Ruby, and a command line interface. One day, I hope to fold in an archive of Native American music of the Great Lakes, and that will be the next step, but for now, my simple scraper can take the Lomax song data and check it against the recorded music in the AllMusic Archive. <a href="https://en.wikipedia.org/wiki/AllMusic">description</a>,<span class="Apple-converted-space">  </span><a href="http://www.allmusic.com/">link </a> </span></p>
<p class="p1"><b>Modeling the structure of the data</b></p>
<p class="p1"><span class="s1">If a blank IDE gives you the willies, you can get the skeletal structure of a gem served to you from the command line by using</span></p>

<pre class="p1"><span class="s1">bundle gem lomax  </span></pre>
<p class="p1">(or whatever you decide to call your gem)</p>
<p class="p1"><span class="s1">I got this hot tip from my excellent coding teacher, Avi Flombaum, director of the <a href="http://flatironschool.com/">Flatiron School</a>. But first, I did it freestyle. I regretted my choice, so go ahead and use the built-in assist and feel great about it. </span></p>
<p class="p1"><span class="s1">I like to practice modeling real life structures as classes and objects. For example: The barking dog who lives next door to me inherits from the SmallDog class <i>and</i> in a fantasy world<i>, </i> the Pig class, and has both annoyance <i>and</i> charm attribute accessors. You get the idea. </span></p>
<p class="p1"><span class="s1">But for this project, I knew I’d be scraping recordings from two different websites, the Alan Lomax Archive of Michigan Songs, and All Music’s listings for songs I might pull up from the Lomax archive to look into throughout recorded music history. I put the scrapers<span class="Apple-converted-space">  </span>for each site in a Scraper class together so I could see the guts of exactly how I was scraping, if any issues arose. </span></p>

<pre class="p1"><span class="s1">class Lomax::Scraper</span>

<span class="s1">end</span></pre>
<p class="p1"><span class="s1">I’d be dealing with recordings and songs. The Lomax recording entries can contain several individual songs, whereas All Music searches by individual song titles, of course. I figured I could manage that distinction by using a single recording class, if I created a <code>#split_recording</code> method inside it. </span></p>

<pre class="p1">class Lomax::Recording
<span class="s1">  def split_recording
</span><span class="s1">    separated_title = self.title.split("; ")
</span><span class="s1">    return separated_title
</span><span class="s1">  end
</span>end</pre>
<p class="p1"><span class="s1">The collection of Michigan recordings I started with exist because of place; they are field recordings after all. So I made a place class too, to represent their Lomax collection site.</span></p>

<pre class="p1"><span class="s1">class Lomax::Place</span>

<span class="s1">end</span></pre>
<p class="p1"><span class="s1"> </span></p>
<p class="p1"><span class="s1">The command line interface class has to exist, so the user data can be accessed and manipulated using some kind of driver; in this case, it’s a simple one. This class does most of the work of this gem. It’s the big controller-coordinator.</span></p>
<p class="p1"><span class="s1">So the classes I thought about modeling were: recordings, place, scraper, and command line interface. The other important files to pre-think about are the executable, and the dependencies. </span></p>
<p class="p1"><span class="s1">The executable file literally gets the code to execute. I titled mine run_lomax. </span></p>

<pre class="p1"><span class="s1">#!/usr/bin/env ruby</span>

<span class="s1">require_relative "../lib/lomax.rb"</span>

<span class="s1">Lomax::CommandLineInterface.new.run</span></pre>
<p class="p1"><span class="s1">That top shebang line tells the shell to use the ruby interpreter to interpret this file, since the file is an executable, and we won’t be typing ruby in front of it to run it. </span></p>
<p class="p1"><span class="s1">The dependencies for this gem are</span></p>

<pre class="p1"><span class="s1">require_relative "./lomax/version.rb"</span>
<span class="s1">require_relative "./lomax/scraper.rb"</span>
<span class="s1">require_relative "./lomax/recording.rb"</span>
<span class="s1">require_relative "./lomax/command_line_interface.rb"</span>
<span class="s1">require_relative "./lomax/place.rb"</span>
<span class="s1">require ‘nokogiri' </span>
<span class="s1">require 'pry'</span>
<span class="s1">require 'open-uri'</span>
<span class="s1">require ‘uri'</span></pre>
<p class="p1">and I threw them into a lomax.rb file.</p>
<p class="p1"><span class="s1">The interesting thing about my inclusion of the URI module is that I had first hard-coded its functionality into my program using regex. (!!!) That was a spaghetti mess of code, I’m embarrassed to say. But sometimes we have to plow the field by hand before we realize we need to get a mule. Hand plowing/gsubing was fine enough for most urls. But, when I typed in a Finnish title with umlauts, I got an error message that looked like this:</span></p>

<pre class="p1"><span class="s1">.../Users/nicolefederici/.rvm/rubies/ruby-2.2.3/lib/ruby/2.2.0/uri/rfc3986_parser.rb:20:in `split': URI must be ascii only "http://www.allmusic.com/search/songs/S\u{ed}r+a+kisl\u{e1}ny+a+Balaton+partj\u{e1}n" (URI::InvalidURIError)</span></pre>
<p class="p1">That "built-in" called URI rocks. URI's escape method converts non-basic ASCII characters to basic ASCII equivalents as required for URLS!</p>
<p class="p1">Here is how to do this:</p>
<p class="p2"><span class="s1"><span class="Apple-converted-space"> </span></span><span class="s1">1. Require 'uri' at beginning of your file</span></p>
<p class="p1"><span class="s1">2. URI.escape (then put the url string with the outlaws in parentheses, like right here.)</span></p>
<p class="p1"><span class="s1">3. That’s it! Wave goodbye to gsubs and regex!</span></p>

<h2 class="p1"><span class="s1"><b>Calibrating the Scrapers</b></span></h2>
<p class="p1"><span class="s1">Just like when you make a pie in the Michigan fashion, gather your ingredients beforehand, and lay them out on a clean counter. Using Google Chrome’s inspector tool, grab the url of the library you will be using, along with the CSS style selectors of any important attributes, and store these somewhere clean for later usage in your method. </span></p>
<p class="p1"><span class="s1">Mine were:</span></p>

<pre class="p1"><span class="s1">big url: <a href="https://www.loc.gov/collections/alan-lomax-in-michigan/index/location/"><span class="s2">https://www.loc.gov/collections/alan-lomax-in-michigan/index/location/</span></a></span>
<span class="s1">.index li: the index lis encompass the name, url, and<span class="Apple-converted-space">  </span>recording count of each place.</span>

<span class="s1">these tags will be:</span>

<span class="s1">name: span.label</span>
<span class="s1">count: span.count</span>
<span class="s1">
The url’s tag was a special case. </span>

<span class="s1">url = "https:" + item.css(“a")[0]["href"]</span></pre>
<p class="p1"><span class="s1">I threw those tags into a simple .each iteration to scrape all the places. I made a compound condition using Boolean operators to kick out all locations catalogued as United States, Michigan, Illinois, Chicago, and Wisconsin, because for this project, I only wanted to use the recordings from Michigan. If I’d allowed Michigan in the title, I would have gotten dups.</span></p>

<pre class="p1"><span class="s1">def self.get_places</span>
<span class="s1">  doc = Nokogiri::HTML(open('https://www.loc.gov/collections/alan-lomax-in-michigan/index/location/'))</span>
<span class="s1">  places_array = []</span>
<span class="s1">  doc.css(".index li").each do |item|</span>
<span class="s1">    name = item.css("span.label").text</span>
<span class="s1">    count = item.css("span.count").text</span>
<span class="s1">    url = "https:" + item.css("a")[0]["href"]</span>
<span class="s1">    if name != "United States" &amp;&amp; name != "Michigan" &amp;&amp; name != "Illinois" &amp;&amp; name != "Chicago" &amp;&amp; name != "Wisconsin"</span>
<span class="s1">      places_array &lt;&lt; Lomax::Place.new(name,count,url)
</span><span class="s1">    end</span>
<span class="s1">  end</span>
<span class="s1">  return places_array
</span><span class="s1">end</span>
</pre>
<p class="p1"><span class="s1">I did the Lomax recordings scraper and the AllMusic Scraper in the same basic manner. The AllMusic Scraper was the one that really needed the URI module. The search that we use when we, as humans, visit the AllMusic site, is also sanitizing these urls. The Lomax scraper spits out information that is designed for a human to read, and I had to get those urls translated into computer speak so my gem could talk to the AllMusic server. </span></p>

<h2 class="p1"><span class="s1"><b>Strange Issue Emerges</b></span></h2>
<p class="p1"><span class="s1">Speed. I like to think of computers as magical organisms that always return information instantly unless they’re broken. I need to let go of this idea. Before I lose another tooth.</span></p>
<p class="p1"><img class="alignnone size-full wp-image-143" src="https://nicolefederici.files.wordpress.com/2016/06/fjbxalnv6zqye.gif" alt="fjbxalnv6zqye" width="280" height="234" /></p>
<p class="p1"><span class="s1">The most exciting information my gem can return is a list of all the songs and their performers, dates, and locations of collection that seem to have no other known recordings in the history of music. My gem spits these out pretty slowly, albeit not as slowly as I’d spit them out if I had to manually look up all 444 of them in All Music, and carefully document them in a notebook. And certainly not as slowly as it would take to build a time machine that travels back to the 1930s and drives around with the Lomaxes gathering them in person. Still, it’s pretty slow in the return department for a little program. At first, I’d modeled the locations as a hash. Talk about slow. When I went back and corrected my concept by making the locations objects that related to the recordings objects, I gained a little speed. It was like going from a Model T to a Ford Mercury. But as an Italian, I want a Maserati… or at least, a pistachio green Fiat. I’m still working on this. </span></p>

<h2 class="p1"><span class="s1"><b>Future Plans</b></span></h2>
<p class="p1"><span class="s1">I’d love to give this gem the ability to play the audio it returns, either singly, or in sequence. Then I could rock out to forgotten hits such as, “Henkensa antoi kaikki kun loi, ja veri se ristilla voittomme toi” and “Roll Her to the Wall”, one after the other, straight from the command line. Look out, DJ Spinna. I’m serious. I see your Stevie Wonder Night and I raise you, sir. ;)</span></p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/vAHOlN-ea8E" frameborder="0" allowfullscreen></iframe>
<p class="p1"><span class="s1">And I don’t think any collection of ancestral Michigan music would be complete without its Native American music. I invite the readers of this post to suggest some Native American archives of Great Lakes music for possible inclusion. You’ll be surprised to find that they aren’t as easy to locate as the Lomax Archive. Please feel free to leave a comment. </span></p>
<p class="p1"><span class="s1">I hope you enjoy hosting your next Bay City Juhannus celebration with authentic jamz from the Alan Lomax Archive. All I have to say is: “S-A <span class="Apple-converted-space">  </span>T-U-R <span class="Apple-converted-space">  </span>D-A-Y …Night!”</span></p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/SrIW63pXVkw" frameborder="0" allowfullscreen></iframe>

Copyright © Nicole Federici 2016 (the original post lives at nicolefederici.wordpress.com)

Featured photograph credit: [Alan Lomax (left) youngster on board boat, during Bahamas recording expedition, 1935 Summer. Rights Advisory: No known restrictions. For more information see: "Lomax Collection (LOT 7414) Rights and Restrictions Information,"<a href="http://lcweb.loc.gov/rr/print/res/159_loma.html">(http://lcweb.loc.gov/rr/print/res/159_loma.html)</a> Call Number: LOT 7414-H, no. N251-1 [P&amp;P], Repository: Library of Congress Prints and Photographs Division Washington, D.C. 20540 USA
